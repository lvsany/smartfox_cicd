name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build-and-validate:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        shell: bash
        working-directory: mirco_service_fox
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Go Build (gateway)
        run: |
          cd gateway
          go build ./...

      - name: Go Build (experiment-service)
        run: |
          cd experiment-service
          go build ./...

      - name: Go Build (user-service)
        run: |
          cd user-service
          go build ./...

      - name: Go Build (notification-service)
        run: |
          cd notification-service
          go build ./...

      - name: Go Build (submission-service)
        run: |
          cd submission-service
          go build ./...

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Python deps (judge-service)
        run: |
          cd judge-service
          python -m pip install -U pip
          pip install -r requirements.txt
          python - <<'PY'
          import flask
          print('Flask version:', flask.__version__)
          PY

      - name: Build Docker images (syntax/metadata check)
        uses: docker/setup-buildx-action@v3

      - name: Build images
        run: |
          docker build -t gateway:ci ./gateway
          docker build -t experiment-service:ci ./experiment-service
          docker build -t user-service:ci ./user-service
          docker build -t notification-service:ci ./notification-service
          docker build -t submission-service:ci ./submission-service
          docker build -t judge-service:ci ./judge-service

      - name: Set up KinD
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: smartfox-ci

      - name: Deploy to KinD and run smoke tests
        run: |
          chmod +x .github/scripts/kind-deploy-and-test.sh
          .github/scripts/kind-deploy-and-test.sh
      - name: E2E smoke
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          chmod +x .github/scripts/smoke-e2e.sh
          .github/scripts/smoke-e2e.sh
      - name: Postman tests
        run: |
          chmod +x .github/scripts/run-newman.sh
          .github/scripts/run-newman.sh
